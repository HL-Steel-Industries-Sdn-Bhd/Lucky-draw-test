<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>Lucky Draw</title>
<style>
body {
  font-family: Arial;
  text-align: center;
  background: #f5f5f5;
}

#wheel-wrapper {
  position: relative;
  width: 320px;
  height: 320px;
  margin: 40px auto;
}

#wheel {
  width: 100%;
  height: 100%;
  transform: rotate(0deg);
}

#pointer {
  position: absolute;
  top: -10px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 10;
}

button {
  padding: 12px 32px;
  font-size: 18px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

.start {
  background: #f4b6b6;
}

.stop {
  background: #b6d9f4;
}

#result {
  margin-top: 20px;
  font-size: 20px;
  min-height: 28px;
}
</style>
</head>

<body>

<h2>Lucky Draw</h2>

<div id="wheel-wrapper">
  <svg id="pointer" width="30" height="20" viewBox="0 0 30 20">
    <polygon points="0,0 30,0 15,20" fill="red"/>
  </svg>
  <svg id="wheel" viewBox="0 0 300 300"></svg>
</div>

<button id="btn" class="start">开始</button>
<div id="result"></div>

<form id="logForm" target="hiddenFrame" method="POST" action="https://script.google.com/macros/s/AKfycbwuUlza6Blel03I1vvrjCl_0ZqAwZx6wOr-z5wn53e1TNn0GXcPftjB06abj9q6jgmX/exec">
  <input type="hidden" name="prize" id="prizeInput">
</form>
<iframe name="hiddenFrame" style="display:none;"></iframe>

<script>
const wheel = document.getElementById("wheel");
const btn = document.getElementById("btn");
const result = document.getElementById("result");

let spinning = false;
let prizeToStop = null;
let rotation = 0;
let animFrameId = null;

// 奖品区块
const prizeAngles = [
  {name:"再来一次", start:0, end:144, color:"#F7A1C4"},
  {name:"三等奖", start:144, end:252, color:"#CD7F32"},
  {name:"二等奖", start:252, end:324, color:"#C0C0C0"},
  {name:"一等奖", start:324, end:360, color:"#FFD700"}
];

// 动态生成 SVG
function generateWheelSVG() {
  const center = 150;
  wheel.innerHTML = '';
  prizeAngles.forEach(p => {
    const startRad = p.start*Math.PI/180;
    const endRad = p.end*Math.PI/180;
    const x1 = center + center*Math.cos(startRad);
    const y1 = center + center*Math.sin(startRad);
    const x2 = center + center*Math.cos(endRad);
    const y2 = center + center*Math.sin(endRad);
    const largeArc = (p.end - p.start) > 180 ? 1 : 0;

    const path = document.createElementNS("http://www.w3.org/2000/svg","path");
    path.setAttribute("d",`M${center},${center} L${x1},${y1} A${center},${center} 0 ${largeArc},1 ${x2},${y2} Z`);
    path.setAttribute("fill",p.color);
    wheel.appendChild(path);

    const textAngle = (p.start+p.end)/2;
    const rad = textAngle*Math.PI/180;
    const textX = center + (center/1.5)*Math.cos(rad);
    const textY = center + (center/1.5)*Math.sin(rad);
    const text = document.createElementNS("http://www.w3.org/2000/svg","text");
    text.setAttribute("x",textX);
    text.setAttribute("y",textY);
    text.setAttribute("font-size","14");
    text.setAttribute("fill","#000");
    text.setAttribute("text-anchor","middle");
    text.setAttribute("dominant-baseline","middle");
    text.textContent = p.name;
    wheel.appendChild(text);
  });
}

generateWheelSVG();

let currentSpeed = 0;
let decelerating = false;

btn.onclick = () => {
  if(!spinning){
    // 开始
    spinning = true;
    btn.textContent = "停止";
    btn.className = "stop";
    result.textContent = "";

    // 决定本次奖品
    const r = Math.random();
    let sum = 0;
    for(let p of prizeAngles){
      sum += (p.end - p.start)/360;
      if(r < sum){
        prizeToStop = p;
        break;
      }
    }

    // 初始加速
    currentSpeed = 10;
    decelerating = false;

    const spin = () => {
      rotation += currentSpeed;
      wheel.style.transform = `rotate(${rotation}deg)`;
      if(!decelerating){
        currentSpeed += 0.5; // 加速
        if(currentSpeed>40) currentSpeed = 40; // 最大速度
      } else {
        currentSpeed *= 0.97; // 减速
        if(currentSpeed<0.5){
          cancelAnimationFrame(animFrameId);
          rotation += 0; // 停稳
          result.textContent = "你获得：" + prizeToStop.name;
          document.getElementById("prizeInput").value = prizeToStop.name;
          document.getElementById("logForm").submit();
          btn.textContent = "开始";
          btn.className = "start";
          spinning = false;
        }
      }
      animFrameId = requestAnimationFrame(spin);
    };
    animFrameId = requestAnimationFrame(spin);

  } else if(spinning && !decelerating){
    // 用户点击停止 → 开始减速
    decelerating = true;

    // 计算最终目标角度在奖品区块内随机
    const randAngle = prizeToStop.start + Math.random()*(prizeToStop.end - prizeToStop.start);
    const currentRotationMod = rotation % 360;
    const extraRotation = (randAngle - currentRotationMod + 360) % 360 + 360*3; // 再转3圈
    rotation += extraRotation;
  }
};
</script>

</body>
</html>
